
define(function(require,exports,module){var $=require('modules/jquery'),jQuery=$;require('theme_css/modules/jrating.css');(function($){$.fn.jRating=function(op){var defaults={bigStarsPath:'jrating/stars.png',smallStarsPath:'jrating/small.png',phpPath:'jRating.php',type:'big',step:false,isDisabled:false,showRateInfo:true,canRateAgain:false,sendRequest:true,length:5,decimalLength:0,rateMax:20,rateInfosX:-45,rateInfosY:5,nbRates:1,onSuccess:null,onError:null,onClick:null};if(this.length>0)
return this.each(function(){var opts=$.extend(defaults,op),newWidth=0,starWidth=0,starHeight=0,bgPath='',hasRated=false,globalWidth=0,nbOfRates=opts.nbRates;if(jQuery(this).hasClass('jDisabled')||opts.isDisabled)
var jDisabled=true;else
var jDisabled=false;getStarWidth();jQuery(this).height(starHeight);var average=parseFloat(jQuery(this).data('average')),idBox=parseInt(jQuery(this).data('id')),widthRatingContainer=starWidth*opts.length,widthColor=average/opts.rateMax*widthRatingContainer,quotient=jQuery('<div>',{'class':'jRatingColor',css:{width:widthColor}}).appendTo(jQuery(this)),average=jQuery('<div>',{'class':'jRatingAverage',css:{width:0,top:-starHeight}}).appendTo(jQuery(this)),jstar=jQuery('<div>',{'class':'jStar',css:{width:widthRatingContainer,height:starHeight,top:-(starHeight*2)}}).appendTo(jQuery(this));jQuery(this).css({width:widthRatingContainer,overflow:'hidden',zIndex:1,position:'relative'});if(!jDisabled)
jQuery(this).off().on({mouseenter:function(e){var realOffsetLeft=findRealLeft(this);var relativeX=e.pageX-realOffsetLeft;if(opts.showRateInfo)
var tooltip=jQuery('<p>',{'class':'jRatingInfos',html:getNote(relativeX)+' <span class="maxRate">/ '+opts.rateMax+'</span>',css:{top:(jQuery(this).offset().top-jQuery(this).height()),left:(e.pageX+opts.rateInfosX)}}).appendTo('body').show();},mouseover:function(e){jQuery(this).css('cursor','pointer');},mouseout:function(){jQuery(this).css('cursor','default');if(hasRated)average.width(globalWidth);else average.width(0);},mousemove:function(e){var realOffsetLeft=findRealLeft(this);var relativeX=e.pageX-realOffsetLeft;if(opts.step)newWidth=Math.floor(relativeX/starWidth)*starWidth+starWidth;else newWidth=relativeX;average.width(newWidth);if(opts.showRateInfo)
jQuery("p.jRatingInfos").css({left:(e.pageX+opts.rateInfosX)}).html(getNote(newWidth)+' <span class="maxRate">/ '+opts.rateMax+'</span>');},mouseleave:function(){jQuery("p.jRatingInfos").remove();},click:function(e){var element=this;hasRated=true;globalWidth=newWidth;nbOfRates--;if(!opts.canRateAgain||parseInt(nbOfRates)<=0)jQuery(this).unbind().css('cursor','default').addClass('jDisabled');if(opts.showRateInfo)jQuery("p.jRatingInfos").fadeOut('fast',function(){jQuery(this).remove();});e.preventDefault();var rate=getNote(newWidth);average.width(newWidth);if(opts.onClick)opts.onClick(element,rate);if(opts.sendRequest){$.ajax({url:opts.phpPath,type:'post',data:{idBox:idBox,rate:rate,action:'rating'},dataType:'json'}).done(function(data,textStatus,jqXHR){if(opts.done)opts.done(data,element,rate,textStatus,jqXHR);}).fail(function(jqXHR,textStatus,errorThrown){if(opts.fail)opts.fail(element,rate,textStatus,jqXHR);}).always(function(){if(opts.always)opts.always(element,rate);});}}});function getNote(relativeX){var noteBrut=parseFloat((relativeX*100/widthRatingContainer)*parseInt(opts.rateMax)/100);var dec=Math.pow(10,parseInt(opts.decimalLength));var note=Math.round(noteBrut*dec)/dec;return note;};function getStarWidth(){switch(opts.type){case'small':starWidth=12;starHeight=10;bgPath=opts.smallStarsPath;break;default:starWidth=23;starHeight=20;bgPath=opts.bigStarsPath;}};function findRealLeft(obj){if(!obj)return 0;return obj.offsetLeft+findRealLeft(obj.offsetParent);};});}})(jQuery);});